# G-02 Template Versioning

> **Phase:** 1.0 | **Status:** Not Started
> **Specs:** [API &sect;5.3, &sect;5.4, &sect;5.6](../specs/5-api-design.md) &middot; [Data](../specs/6-data-model.md)

## Goal Statement

使用者與 crew 成員可安全編輯訓練 template，且保留完整歷史。

## Requirement

系統必須提供 template CRUD 與 append-only 版本快照。

## In Scope

1. Template CRUD
2. Crew 共編 template
3. 每次編輯建立新版本

## Out Scope

1. Template merge UI
2. 跨版本自動衝突解決

## Frontend Elements

1. Template 編輯頁（動作清單與編輯器）
2. 版本歷史面板（version list）
3. Crew 共編狀態區塊（成員與權限提示）
4. 自訂動作建立彈窗（含圖片上傳狀態）

## Acceptance Criteria

- [ ] Given 同一份 template 被更新，When 儲存成功，Then 產生新 version，不覆蓋舊版。
- [ ] Given crew 成員有權限，When 編輯 template，Then 變更可被其他成員讀取。
- [ ] Given 使用者建立自訂動作並上傳圖片，When pre-signed upload + complete 成功，Then 該動作可加入 template 並被保存。
- [ ] Given template 分享到 crew，When 任一成員編輯後儲存，Then 版本歷史需保留編輯者資訊。

## Tasks

1. PR-1 feat(api): exercise module — shared schemas + CRUD API

- 建立 `packages/shared/src/exercises.ts` Zod schemas（create custom, list preset, get detail）
- 建立 `apps/api/src/modules/exercises/` — routes, controller, service
- Endpoints: `GET /exercises/preset`, `POST /exercises/custom`, `GET /exercises/:exerciseId`
- TDD：`exercise.service.test.ts`

1. PR-2 feat(api): media upload — DB migration + pre-signed URL API

- `packages/database/src/schema/enums.ts` 新增 `mediaStatusEnum`
- 建立 `packages/database/src/schema/exercise-media.ts`（exercise_media table）+ DB migration
- 建立 `packages/shared/src/media.ts` Zod schemas
- 建立 `apps/api/src/modules/media/` — routes, controller, service
- S3 presigned URL utility（`apps/api/src/lib/storage.ts`）
- Endpoints: `POST /media/upload-url`, `POST /media/complete`
- TDD：`media.service.test.ts`

1. PR-3 feat(api): template CRUD — shared schemas + items management

- 建立 `packages/shared/src/templates.ts` Zod schemas（create, update, items）
- 建立 `apps/api/src/modules/templates/` — routes, controller, service
- Endpoints: `POST /templates`, `GET /templates`, `GET /templates/:templateId`, `PATCH /templates/:templateId`
- Template items: `POST /items`, `PATCH /items/:itemId`, `DELETE /items/:itemId`
- 權限檢查：owner only
- TDD：`template.service.test.ts`

1. PR-4 feat(api): template versioning + crew sharing

- 擴展 template service：每次 save 建立 append-only version snapshot
- `GET /templates/:templateId/versions` — 版本歷史
- `POST /templates/:templateId/share` — 分享到 crew
- Crew 成員權限檢查（owner 或 crew member 可讀寫）
- `GET /templates` 擴展為包含 shared templates
- TDD：versioning + sharing + permission

1. PR-5 feat(web): template list, editor, and API clients

- API clients（templates, exercises）
- Template list page（`/templates`）
- Template editor page（`/templates/$templateId/edit`）
- Template create flow + exercise 選擇
- Route definitions + 導航整合

1. PR-6 feat(web): version history, crew UI, custom exercise dialog

- 版本歷史面板 component
- Crew 共編狀態區塊（成員與權限提示）
- 自訂動作建立彈窗（含圖片上傳、media API 整合）
- E2E tests for critical flows
