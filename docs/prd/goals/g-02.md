# G-02 Template Versioning

> **Phase:** 1.0 | **Status:** Not Started
> **Specs:** [API &sect;5.3, &sect;5.4, &sect;5.6](../specs/5-api-design.md) &middot; [Data](../specs/6-data-model.md)

## Goal Statement

使用者可安全編輯訓練 template，並可分享給朋友；朋友透過通知查看唯讀預覽後，可選擇複製為自己的 template，同時保留完整歷史。

## Requirement

系統必須提供 template CRUD、append-only 版本快照，以及分享通知與唯讀預覽複製流程。

## In Scope

1. Template CRUD
2. 朋友間 template 分享（通知入口）
3. 朋友端唯讀預覽與複製為個人 template
4. 每次編輯建立新版本

## Out Scope

1. Template merge UI
2. 跨版本自動衝突解決

## Frontend Elements

1. Template 編輯頁（動作清單與編輯器）
2. 版本歷史面板（version list）
3. 分享按鈕（可分享 template 給朋友）
4. 通知中心提示被分享 template
5. 點擊通知中心的被分享 template 提示後可以查看 shared template
6. Shared Template 預覽頁（唯讀 + 複製到我的 Templates）
7. 自訂動作建立彈窗（含圖片上傳狀態）

## Acceptance Criteria

- [ ] Given 同一份 template 被更新，When 儲存成功，Then 產生新 version，不覆蓋舊版。
- [ ] Given 使用者將 template 分享給朋友，When 分享成功，Then 朋友通知中心會收到一則可點擊的分享通知。
- [ ] Given 朋友點擊分享通知，When 進入 shared template 預覽頁，Then 可讀取內容但不可直接編輯原始 template。
- [ ] Given 朋友在 shared template 預覽頁點擊「複製到我的 Templates」，When 複製成功，Then 產生可由朋友編輯的新 template 副本。
- [ ] Given 使用者建立自訂動作並上傳圖片，When pre-signed upload + complete 成功，Then 該動作可加入 template 並被保存。
- [ ] Given template 分享給朋友，When 朋友另存為自己的 template 後編輯，Then 原始 template 版本歷史不受影響。

## Tasks

1. PR-1 feat(api): exercise module — shared schemas + CRUD API

- 建立 `packages/shared/src/exercises.ts` Zod schemas（create custom, list preset, get detail）
- 建立 `apps/api/src/modules/exercises/` — routes, controller, service
- Endpoints: `GET /exercises/preset`, `POST /exercises/custom`, `GET /exercises/:exerciseId`
- TDD：`exercise.service.test.ts`

1. PR-2 feat(api): media upload — DB migration + pre-signed URL API

- `packages/database/src/schema/enums.ts` 新增 `mediaStatusEnum`
- 建立 `packages/database/src/schema/exercise-media.ts`（exercise_media table）+ DB migration
- 建立 `packages/shared/src/media.ts` Zod schemas
- 建立 `apps/api/src/modules/media/` — routes, controller, service
- S3 presigned URL utility（`apps/api/src/lib/storage.ts`）
- Endpoints: `POST /media/upload-url`, `POST /media/complete`
- TDD：`media.service.test.ts`

1. PR-3 feat(api): template CRUD — shared schemas + items management

- 建立 `packages/shared/src/templates.ts` Zod schemas（create, update, items）
- 建立 `apps/api/src/modules/templates/` — routes, controller, service
- Endpoints: `POST /templates`, `GET /templates`, `GET /templates/:templateId`, `PATCH /templates/:templateId`
- Template items: `POST /items`, `PATCH /items/:itemId`, `DELETE /items/:itemId`
- 權限檢查：owner only
- TDD：`template.service.test.ts`

1. PR-4 feat(api): template versioning + friend sharing

- 擴展 template service：每次 save 建立 append-only version snapshot
- `GET /templates/:templateId/versions` — 版本歷史
- `POST /templates/:templateId/share` — 分享給朋友
- 朋友權限檢查（friend 可讀取，不可直接編輯原始 template）
- `POST /templates/:templateId/copy-from-share` — 從分享複製為自己的 template
- TDD：versioning + sharing + permission + copy flow

1. PR-5 feat(api): sharing notification API

- 建立 notifications module（template share 類型）
- `GET /notifications` — 取得通知列表（含 template share card）
- `PATCH /notifications/:notificationId/read` — 標記已讀
- 分享成功時建立通知事件與通知資料
- TDD：notification creation + list + read

1. PR-6 feat(web): template list, editor, and API clients

- API clients（templates, exercises）
- Template list page（`/templates`）
- Template editor page（`/templates/$templateId/edit`）
- Template create flow + exercise 選擇
- Route definitions + 導航整合

1. PR-7 feat(web): version history, sharing notification UI, custom exercise dialog

- 版本歷史面板 component
- 分享動作按鈕
- 通知中心分享卡片 + 點擊導到 shared template 預覽頁
- Shared template 預覽頁（唯讀）+ 複製到我的 Templates 按鈕
- 自訂動作建立彈窗（含圖片上傳、media API 整合）
- E2E tests for critical flows
