# G-18 Authentication and Session Security

> **Phase:** 1.0 | **Status:** Not Started
> **Specs:** [API &sect;5.2](../specs/5-api-design.md) &middot; [Data](../specs/6-data-model.md) &middot; [Frontend &sect;4.1](../specs/4-frontend-architecture.md)

## Goal Statement

使用者可以安全登入並維持可控的登入狀態。

## Requirement

系統必須提供帳號登入、refresh rotation、token reuse 防護與基本授權邊界。

## In Scope

1. Local register/login
2. Access token + refresh token rotation
3. `/auth/me` session restore
4. Logout revoke

## Out Scope

1. 多因子驗證（MFA）
2. Google Login
3. SSO enterprise federation

## Frontend Elements

1. 註冊/登入表單
2. Session restore 載入狀態
3. 登出入口與重新登入提示

## Acceptance Criteria

- [ ] 1. 使用者可用 Email/Password 成功註冊並登入，登入後可立即使用需要登入的功能。
- [ ] 2. 當登入憑證過期時，系統會自動延續登入狀態；使用者不需要頻繁重新登入。
- [ ] 3. 若系統偵測到可疑的 refresh token 重用行為，會立即終止該登入家族並要求重新登入，避免帳號被持續濫用。
- [ ] 4. 使用者登出後，原本的 refresh token 不可再用於換發新憑證。
- [ ] 5. 使用者重新開啟 App/重新整理頁面時，系統可正確還原登入狀態，或在失效時明確顯示未登入狀態。
- [ ] 6. 系統對未登入使用者有清楚的授權邊界，受保護頁面與 API 不可被未授權存取。

## Tasks

> Constraint: 每個 PR 變更量需控制在 500 行以內（`git diff --stat`）。

- [x] PR-1 feat(web): auth client and session provider foundation

- 建立前端 auth API client（login/register/refresh/logout/me）
- 建立 src/providers/index.tsx 單一入口與 auth session state
- 建立 session 狀態模型（unknown/authenticated/anonymous）

- [-] PR-2 feat(web): login/register pages and basic auth UX

- 新增 /auth/login、/auth/register
- 表單驗證與錯誤提示
- 登入/註冊成功後導向（含 redirect target）

- [] PR-3 feat(web): session restore, guarded routes, and header auth actions

- App 啟動 session restore（refresh -> me）
- 受保護路由 guard
- 全域 header 改為依登入狀態顯示登入/登出與使用者操作

- [] PR-4 test: auth integration and critical e2e flows

- API 整合測試：register/login/refresh/logout/me、rotation/reuse
- E2E：登入成功、過期後自動恢復、登出後不可 refresh
- 補齊失敗路徑與安全旗標驗證

- [] PR-5 feat(auth): derive local register display name from email

- 註冊 payload 移除 `name` 欄位
- 後端在註冊時以 email `@` 前綴自動產生名稱
- 維持現有註冊成功流程與回傳結構

- [] PR-6 feat(auth): email verification for local registration

- Local 註冊後需先完成 email 驗證
- 未驗證 email 不可完成一般登入流程
- 補齊驗證流程 API 與關鍵測試

- [] PR-7 feat(web): Google sign-in button UI (UI only)

- 在登入/註冊頁加入 Google 登入按鈕視覺元件
- 僅提供 UI 與互動狀態（不含 Google OAuth 後端流程）
- 與既有 auth 表單樣式與版面一致
